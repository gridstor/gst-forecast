---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Schedule Management Dashboard">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Schedule Management</h1>
        <p class="text-gray-600">Track and manage curve delivery schedules</p>
      </div>
      <div class="mt-4 sm:mt-0 flex space-x-3">
        <a href="/curve-schedule/create-enhanced" 
           class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
          Create Schedule
        </a>
        <button id="refreshBtn" 
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          Refresh
        </button>
      </div>
    </div>

    <!-- Summary Stats -->
    <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
      <div class="bg-white p-4 rounded-lg shadow border">
        <div class="text-2xl font-bold text-gray-900" id="totalCount">-</div>
        <div class="text-sm text-gray-500">Total Schedules</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow border">
        <div class="text-2xl font-bold text-blue-600" id="scheduledCount">-</div>
        <div class="text-sm text-gray-500">Scheduled</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow border">
        <div class="text-2xl font-bold text-amber-600" id="inProgressCount">-</div>
        <div class="text-sm text-gray-500">In Progress</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow border">
        <div class="text-2xl font-bold text-green-600" id="completedCount">-</div>
        <div class="text-sm text-gray-500">Completed</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow border">
        <div class="text-2xl font-bold text-red-600" id="overdueCount">-</div>
        <div class="text-sm text-gray-500">Overdue</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <!-- View Toggle -->
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <div class="flex bg-gray-100 rounded-lg p-1">
          <button id="gridViewBtn" class="px-4 py-2 rounded-md text-sm font-medium bg-white text-gray-900 shadow-sm">
            Grid View
          </button>
          <button id="calendarViewBtn" class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900">
            Calendar View
          </button>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="hidden items-center space-x-2">
          <span class="text-sm text-gray-600" id="selectedCount">0 selected</span>
          <button id="bulkDeleteBtn" 
                  class="px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
            Delete Selected
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Status Filter -->
        <div>
          <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Statuses</option>
            <option value="SCHEDULED">Scheduled</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
            <option value="OVERDUE">Overdue</option>
          </select>
        </div>

        <!-- Market Filter -->
        <div>
          <label for="marketFilter" class="block text-sm font-medium text-gray-700 mb-1">Market</label>
          <select id="marketFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Markets</option>
            <option value="ERCOT">ERCOT</option>
            <option value="CAISO">CAISO</option>
            <option value="PJM">PJM</option>
            <option value="MISO">MISO</option>
          </select>
        </div>

        <!-- Team Filter -->
        <div>
          <label for="teamFilter" class="block text-sm font-medium text-gray-700 mb-1">Team</label>
          <select id="teamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Teams</option>
            <option value="Analytics">Analytics</option>
            <option value="Finance">Finance</option>
            <option value="M&A">M&A</option>
            <option value="Commercial">Commercial</option>
            <option value="Goldman">Goldman</option>
            <option value="Trading/Risk">Trading/Risk</option>
          </select>
        </div>

        <!-- Curve Type Filter -->
        <div>
          <label for="curveTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">Curve Type</label>
          <select id="curveTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Types</option>
            <option value="REVENUE">Revenue</option>
            <option value="ENERGY_ARB">Energy Arbitrage</option>
            <option value="AS">Ancillary Services</option>
            <option value="TB2">Two-Hour Battery</option>
            <option value="TB4">Four-Hour Battery</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Grid View -->
    <div id="gridView" class="bg-white rounded-lg shadow-md">
      <!-- Loading State -->
      <div id="loadingState" class="p-8 text-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <div class="text-gray-600">Loading schedules...</div>
      </div>

      <!-- Grid Content -->
      <div id="gridContent" class="hidden">
        <!-- Table Header -->
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex items-center">
            <input type="checkbox" id="selectAll" 
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-4">
            <h3 class="text-lg font-medium text-gray-900">Schedule List</h3>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                  Select
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Curve
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Market/Location
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Team
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Next Due
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Priority
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="scheduleTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Dynamic content will be inserted here -->
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden p-8 text-center">
          <div class="text-gray-400 mb-4">
            <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No schedules found</h3>
          <p class="text-gray-600 mb-4">Create your first curve schedule to get started.</p>
          <a href="/curve-schedule/create-enhanced" 
             class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Create Schedule
          </a>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div id="calendarView" class="hidden bg-white rounded-lg shadow-md p-6">
      <div id="calendar"></div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">Error loading schedules</h3>
          <div class="mt-2 text-sm text-red-700" id="errorMessage">
            Failed to load schedule data. Please try refreshing the page.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Schedule Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4" id="editModalTitle">Edit Schedule</h3>
        <form id="editForm" class="space-y-4">
          <input type="hidden" id="editScheduleId">
          
          <!-- Edit form fields (simplified for space) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="editFrequency" class="block text-sm font-medium text-gray-700">Frequency</label>
              <select id="editFrequency" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="DAILY">Daily</option>
                <option value="WEEKLY">Weekly</option>
                <option value="MONTHLY">Monthly</option>
                <option value="QUARTERLY">Quarterly</option>
                <option value="ANNUALLY">Annually</option>
              </select>
            </div>
            
            <div>
              <label for="editImportance" class="block text-sm font-medium text-gray-700">Importance</label>
              <select id="editImportance" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="1">1 - Low</option>
                <option value="2">2</option>
                <option value="3">3 - Medium</option>
                <option value="4">4</option>
                <option value="5">5 - Critical</option>
              </select>
            </div>
            
            <div>
              <label for="editTeam" class="block text-sm font-medium text-gray-700">Responsible Team</label>
              <select id="editTeam" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="Analytics">Analytics</option>
                <option value="Finance">Finance</option>
                <option value="M&A">M&A</option>
                <option value="Commercial">Commercial</option>
                <option value="Goldman">Goldman</option>
                <option value="Trading/Risk">Trading/Risk</option>
              </select>
            </div>
            
            <div>
              <label for="editFreshnessDays" class="block text-sm font-medium text-gray-700">Freshness Days</label>
              <input type="number" id="editFreshnessDays" name="freshnessDays" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" id="cancelEdit" 
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Include FullCalendar for calendar view -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

  <script src="/js/schedule-management.js" is:inline></script>
</Layout> 